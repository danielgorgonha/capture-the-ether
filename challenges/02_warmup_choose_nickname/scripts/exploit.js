const hre = require("hardhat");

async function main() {
  console.log("ðŸ” Iniciando exploit do NicknameChallenge...\n");

  // EndereÃ§os dos contratos podem ser passados como variÃ¡veis de ambiente
  // Se nÃ£o fornecidos, fazemos o deploy primeiro
  let cteAddress = process.env.CTE_ADDRESS;
  let challengeAddress = process.env.CHALLENGE_ADDRESS;
  
  if (!cteAddress || !challengeAddress) {
    console.log("ðŸ“¦ EndereÃ§os nÃ£o fornecidos. Fazendo deploy dos contratos...\n");
    
    const [deployer, player] = await hre.ethers.getSigners();
    
    // Deploy do CaptureTheEther
    const CaptureTheEther = await hre.ethers.getContractFactory("challenges/02_warmup_choose_nickname/contracts/CaptureTheEther.sol:CaptureTheEther");
    const captureTheEther = await CaptureTheEther.deploy();
    await captureTheEther.waitForDeployment();
    cteAddress = await captureTheEther.getAddress();
    
    // Deploy do NicknameChallenge
    const NicknameChallenge = await hre.ethers.getContractFactory("challenges/02_warmup_choose_nickname/contracts/NicknameChallenge.sol:NicknameChallenge");
    const nicknameChallenge = await NicknameChallenge.deploy(player.address, cteAddress);
    await nicknameChallenge.waitForDeployment();
    challengeAddress = await nicknameChallenge.getAddress();
    
    console.log("âœ… Contratos deployados:");
    console.log("  - CaptureTheEther:", cteAddress);
    console.log("  - NicknameChallenge:", challengeAddress);
    console.log("");
  }

  // Conectar aos contratos
  const CaptureTheEther = await hre.ethers.getContractFactory("challenges/02_warmup_choose_nickname/contracts/CaptureTheEther.sol:CaptureTheEther");
  const NicknameChallenge = await hre.ethers.getContractFactory("challenges/02_warmup_choose_nickname/contracts/NicknameChallenge.sol:NicknameChallenge");
  
  const cte = CaptureTheEther.attach(cteAddress);
  const challenge = NicknameChallenge.attach(challengeAddress);

  // Obter o endereÃ§o do jogador (primeira conta)
  const [player] = await hre.ethers.getSigners();
  
  // Verificar estado antes do exploit
  const nicknameBefore = await cte.nicknameOf(player.address);
  const isCompleteBefore = await challenge.isComplete();
  
  console.log("ðŸ“ EndereÃ§os:");
  console.log("  - CaptureTheEther:", cteAddress);
  console.log("  - NicknameChallenge:", challengeAddress);
  console.log("  - Jogador:", player.address);
  console.log("");
  console.log("ðŸ“Š Estado antes do exploit:");
  console.log("  - Nickname:", nicknameBefore === "0x0000000000000000000000000000000000000000000000000000000000000000" ? "(vazio)" : hre.ethers.toUtf8String(nicknameBefore));
  console.log("  - Desafio completo:", isCompleteBefore);
  console.log("");

  if (isCompleteBefore) {
    console.log("âœ… O desafio jÃ¡ estÃ¡ completo!");
    return;
  }

  // Executar o exploit: definir um nickname
  console.log("ðŸŽ¯ Executando exploit: definindo nickname...\n");
  
  // Converter string para bytes32
  const nickname = hre.ethers.encodeBytes32String("Hacker");
  console.log("ðŸ“ Definindo nickname:", hre.ethers.toUtf8String(nickname));
  
  const tx = await cte.setNickname(nickname);
  console.log("ðŸ“¤ Transaction enviada:", tx.hash);
  
  await tx.wait();
  console.log("âœ… Transaction confirmada!\n");

  // Verificar estado apÃ³s o exploit
  const nicknameAfter = await cte.nicknameOf(player.address);
  const isCompleteAfter = await challenge.isComplete();
  
  console.log("ðŸ“Š Estado apÃ³s o exploit:");
  console.log("  - Nickname:", hre.ethers.toUtf8String(nicknameAfter));
  console.log("  - Desafio completo:", isCompleteAfter);
  
  if (isCompleteAfter) {
    console.log("\nðŸŽ‰ Desafio completado! O nickname foi definido com sucesso");
    console.log("ðŸ’¡ Use o endereÃ§o do CaptureTheEther no site Capture the Ether para verificar");
    console.log("ðŸ’¡ EndereÃ§o na rede Ropsten real: 0x71c46Ed333C35e4E6c62D32dc7C8F00D125b4fee");
  } else {
    console.log("\nâŒ Algo deu errado. O desafio nÃ£o foi completado.");
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });

