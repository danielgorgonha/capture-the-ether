const hre = require("hardhat");

async function main() {
  console.log("ðŸ” Iniciando exploit do NicknameChallenge...\n");

  // EndereÃ§os dos contratos podem ser passados como variÃ¡veis de ambiente
  // Se nÃ£o fornecidos, fazemos o deploy primeiro
  let cteAddress = process.env.CTE_ADDRESS;
  let challengeAddress = process.env.CHALLENGE_ADDRESS;
  
  const [deployer, player] = await hre.ethers.getSigners();
  let playerAddress = player.address; // Usar a segunda conta como jogador (padrÃ£o do deploy)
  
  if (!cteAddress || !challengeAddress) {
    console.log("ðŸ“¦ EndereÃ§os nÃ£o fornecidos. Fazendo deploy dos contratos...\n");
    
    // Deploy do CaptureTheEther
    const CaptureTheEther = await hre.ethers.getContractFactory("challenges/02_warmup_choose_nickname/contracts/CaptureTheEther.sol:CaptureTheEther");
    const captureTheEther = await CaptureTheEther.deploy();
    await captureTheEther.waitForDeployment();
    cteAddress = await captureTheEther.getAddress();
    
    // Deploy do NicknameChallenge usando a segunda conta como jogador
    const NicknameChallenge = await hre.ethers.getContractFactory("challenges/02_warmup_choose_nickname/contracts/NicknameChallenge.sol:NicknameChallenge");
    const nicknameChallenge = await NicknameChallenge.deploy(player.address, cteAddress);
    await nicknameChallenge.waitForDeployment();
    challengeAddress = await nicknameChallenge.getAddress();
    
    console.log("âœ… Contratos deployados:");
    console.log("  - CaptureTheEther:", cteAddress);
    console.log("  - NicknameChallenge:", challengeAddress);
    console.log("  - Jogador:", player.address);
    console.log("");
  }

  // Conectar aos contratos
  const CaptureTheEther = await hre.ethers.getContractFactory("challenges/02_warmup_choose_nickname/contracts/CaptureTheEther.sol:CaptureTheEther");
  const NicknameChallenge = await hre.ethers.getContractFactory("challenges/02_warmup_choose_nickname/contracts/NicknameChallenge.sol:NicknameChallenge");
  
  const cte = CaptureTheEther.attach(cteAddress);
  const challenge = NicknameChallenge.attach(challengeAddress);

  // Se os contratos jÃ¡ foram deployados, vamos tentar descobrir qual endereÃ§o estÃ¡ sendo verificado
  // Por padrÃ£o, vamos usar a segunda conta (player) que Ã© o padrÃ£o do deploy
  
  // Verificar estado antes do exploit
  // O NicknameChallenge verifica o endereÃ§o que foi passado no construtor
  // Vamos tentar descobrir qual endereÃ§o estÃ¡ sendo verificado
  // Por padrÃ£o, vamos usar a primeira conta (deployer)
  const nicknameBefore = await cte.nicknameOf(playerAddress);
  const isCompleteBefore = await challenge.isComplete();
  
  console.log("ðŸ“ EndereÃ§os:");
  console.log("  - CaptureTheEther:", cteAddress);
  console.log("  - NicknameChallenge:", challengeAddress);
  console.log("  - Jogador (usando):", playerAddress);
  console.log("");
  console.log("ðŸ“Š Estado antes do exploit:");
  console.log("  - Nickname:", nicknameBefore === "0x0000000000000000000000000000000000000000000000000000000000000000" ? "(vazio)" : hre.ethers.toUtf8String(nicknameBefore));
  console.log("  - Desafio completo:", isCompleteBefore);
  console.log("");

  if (isCompleteBefore) {
    console.log("âœ… O desafio jÃ¡ estÃ¡ completo!");
    return;
  }

  // Executar o exploit: definir um nickname
  console.log("ðŸŽ¯ Executando exploit: definindo nickname...\n");
  
  // Converter string para bytes32
  const nickname = hre.ethers.encodeBytes32String("Hacker");
  console.log("ðŸ“ Definindo nickname:", hre.ethers.toUtf8String(nickname));
  
  // Chamar setNickname usando a conta do jogador (player)
  const tx = await cte.connect(player).setNickname(nickname);
  console.log("ðŸ“¤ Transaction enviada:", tx.hash);
  
  await tx.wait();
  console.log("âœ… Transaction confirmada!\n");

  // Verificar estado apÃ³s o exploit
  const nicknameAfter = await cte.nicknameOf(playerAddress);
  const isCompleteAfter = await challenge.isComplete();
  
  console.log("ðŸ“Š Estado apÃ³s o exploit:");
  console.log("  - Nickname:", hre.ethers.toUtf8String(nicknameAfter));
  console.log("  - Desafio completo:", isCompleteAfter);
  
  if (isCompleteAfter) {
    console.log("\nðŸŽ‰ Desafio completado! O nickname foi definido com sucesso");
  } else {
    console.log("\nâŒ Algo deu errado. O desafio nÃ£o foi completado.");
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });

