const hre = require("hardhat");

async function main() {
  console.log("ðŸ” Iniciando exploit do CallMeChallenge...\n");

  // O endereÃ§o do contrato pode ser passado como variÃ¡vel de ambiente
  // Se nÃ£o fornecido, fazemos o deploy primeiro
  let contractAddress = process.env.CONTRACT_ADDRESS;
  
  if (!contractAddress) {
    console.log("ðŸ“¦ Nenhum endereÃ§o fornecido. Fazendo deploy do contrato...\n");
    
    const [deployer] = await hre.ethers.getSigners();
    const CallMeChallenge = await hre.ethers.getContractFactory("CallMeChallenge");
    const callMeChallenge = await CallMeChallenge.deploy();
    await callMeChallenge.waitForDeployment();
    contractAddress = await callMeChallenge.getAddress();
    
    console.log("âœ… Contrato deployado em:", contractAddress);
    console.log("");
  }

  // Conectar ao contrato
  const CallMeChallenge = await hre.ethers.getContractFactory("CallMeChallenge");
  const contract = CallMeChallenge.attach(contractAddress);

  // Verificar estado antes do exploit
  const isCompleteBefore = await contract.isComplete();
  console.log("ðŸ“ EndereÃ§o do contrato:", contractAddress);
  console.log("ðŸ“Š Estado antes do exploit - isComplete:", isCompleteBefore);
  console.log("");

  if (isCompleteBefore) {
    console.log("âœ… O desafio jÃ¡ estÃ¡ completo!");
    return;
  }

  // Executar o exploit: chamar a funÃ§Ã£o callme()
  console.log("ðŸŽ¯ Executando exploit: chamando funÃ§Ã£o callme()...\n");
  
  const [attacker] = await hre.ethers.getSigners();
  const tx = await contract.callme();
  console.log("ðŸ“¤ Transaction enviada:", tx.hash);
  
  await tx.wait();
  console.log("âœ… Transaction confirmada!\n");

  // Verificar estado apÃ³s o exploit
  const isCompleteAfter = await contract.isComplete();
  console.log("ðŸ“Š Estado apÃ³s o exploit - isComplete:", isCompleteAfter);
  
  if (isCompleteAfter) {
    console.log("\nðŸŽ‰ Desafio completado! A funÃ§Ã£o callme() foi chamada com sucesso");
    console.log("ðŸ’¡ Use este endereÃ§o no site Capture the Ether para verificar a soluÃ§Ã£o");
  } else {
    console.log("\nâŒ Algo deu errado. O desafio nÃ£o foi completado.");
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });

